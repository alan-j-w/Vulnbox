{% extends 'base.html' %}

{% block title %}#{{ channel.name }} | Community Hub{% endblock %}

{% block extra_head %}
<style>
    .chat-page-container {
        height: calc(100vh - 160px);
        min-height: 500px;
    }
    .chat-bubble {
        max-width: 75%;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .chat-bubble.sent { align-self: flex-end; text-align: right; }
    .chat-bubble.received { align-self: flex-start; text-align: left; }
    .chat-avatar { width: 2rem; height: 2rem; border-radius: 9999px; object-fit: cover; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8 text-white flex flex-col chat-page-container">
    <!-- Header -->
    <header class="mb-4 flex-shrink-0">
        <a href="{% url 'core:community_hub' %}" class="text-sm text-green-400 hover:underline">&larr; Back to Channels</a>
        <h1 class="text-3xl font-bold text-green-400 mt-2">#{{ channel.name }}</h1>
        <p class="text-md text-gray-400">{{ channel.description }}</p>
    </header>

    <!-- Chat Container -->
    <div class="bg-black/70 border-2 border-green-500/50 rounded-xl backdrop-blur-sm flex flex-col flex-grow min-h-0">
        <div id="chat-messages" class="flex flex-col flex-grow p-6 space-y-4 overflow-y-auto"></div>

        <!-- Input Form -->
        <div class="p-4 border-t border-green-500/50 flex-shrink-0">
            <form id="chat-form" class="flex items-center gap-4">
                {% csrf_token %}
                <input type="text" id="message-input" name="content" required autocomplete="off"
                    class="flex-grow w-full bg-gray-900/50 border-2 border-green-700 rounded-md p-3 text-white focus:outline-none focus:ring-2 focus:ring-green-400 font-mono"
                    placeholder="Type a message...">
                <button type="submit"
                    class="bg-green-600 text-black font-bold py-3 px-6 rounded-lg hover:bg-green-500 transition-colors">
                    Send
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// === CSRF helper ===
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        for (let cookie of document.cookie.split(';')) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.addEventListener('DOMContentLoaded', () => {
    const chatBox = document.getElementById("chat-messages");
    const chatForm = document.getElementById("chat-form");
    const messageInput = document.getElementById("message-input");
    const channelId = "{{ channel.id }}";
    const currentUsername = "{{ user.username }}";

    // Scroll helper
    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Load messages via AJAX
    async function loadMessages(forceScroll = false) {
        try {
            const response = await fetch(`/community/${channelId}/fetch/`);
            if (!response.ok) return;

            const data = await response.json();
            const shouldScroll =
                forceScroll || chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 100;

            chatBox.innerHTML = "";
            data.messages.forEach(msg => {
                const isSent = msg.is_own_message || msg.author === currentUsername;
                const bubble = document.createElement("div");
                bubble.classList.add("chat-bubble", isSent ? "sent" : "received");

                bubble.innerHTML = `
                    <div class="flex items-center ${isSent ? "justify-end" : "justify-start"} gap-2 mb-1">
                        ${isSent ? `
                            <span class="font-bold text-sm text-green-400">${msg.author}</span>
                            <img src="${msg.profile_picture}" class="chat-avatar" alt="User">
                        ` : `
                            <img src="${msg.profile_picture}" class="chat-avatar" alt="User">
                            <span class="font-bold text-sm text-gray-300">${msg.author}</span>
                        `}
                    </div>
                    <div class="p-3 rounded-lg ${isSent ? "bg-green-900/50" : "bg-gray-800/50"}">
                        <p class="text-white break-words">${msg.content}</p>
                        <p class="text-xs text-gray-500 mt-1">${msg.timestamp}</p>
                    </div>
                `;
                chatBox.appendChild(bubble);
            });

            if (shouldScroll) scrollToBottom();
        } catch (err) {
            console.error("Error fetching messages:", err);
        }
    }

    // Send message via AJAX
    async function sendMessage(e) {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (!content) return;

        try {
            messageInput.disabled = true;
            const res = await fetch(`/community/${channelId}/send/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrftoken
                },
                body: `content=${encodeURIComponent(content)}`
            });

            const data = await res.json();
            if (data.success) {
                messageInput.value = "";
                await loadMessages(true);
            } else {
                alert(data.error || "Message not sent.");
            }
        } catch (err) {
            console.error("Error sending message:", err);
        } finally {
            messageInput.disabled = false;
            messageInput.focus();
        }
    }

    chatForm.addEventListener("submit", sendMessage);
    loadMessages(true);
    setInterval(() => loadMessages(false), 2500); // Real-time refresh
});
</script>
{% endblock %}
